name: Release Tau

permissions:
  contents: write # Necesario para que el bot pueda crear Releases y subir archivos

on:
  push:
    tags:
      - 'v*' # Se ejecuta solo cuando subes un tag como v1.0.0, v0.1.0, etc.
  workflow_dispatch: # Permite ejecutarlo manualmente desde la pestaña Actions si es necesario

jobs:
  publish-tauri:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        platform: [ubuntu-22.04] # Puedes agregar windows-latest o macos-latest aquí en el futuro

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Configurar Rust (Esencial para Tauri)
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      # 2. Instalar dependencias del sistema (Linux/Ubuntu)
      # Nota: libayatana-appindicator3-dev es CRUCIAL para apps de clipboard/tray en Linux
      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libsoup-3.0-dev javascriptcoregtk-4.1-dev

      # 3. Configurar PNPM (Forma moderna y rápida)
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9 # O la versión que uses
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'pnpm'

      # 4. Instalar dependencias del proyecto
      - name: Install frontend dependencies
        run: pnpm install

      # 5. Build y Release Automático con Tauri Action
      # Esta acción compila el frontend, el backend (Rust), crea el .deb/.AppImage
      # y los sube a un nuevo Release en GitHub basado en tu tag.
      - name: Build and Create Release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }} # Usa el nombre del tag (ej: v0.1.0)
          releaseName: 'Tau App v__VERSION__' # Reemplaza __VERSION__ con la versión real
          releaseBody: 'See the assets to download this version and install.'
          releaseDraft: true # Lo crea como borrador para que revises antes de publicar (opcional)
          prerelease: false