name: Build and Release Tuxclip App

on:
  push:
    branches:
      - main
  release:
    types:
      - published

jobs:
  build:
    runs-on: ubuntu-22.04  # Se mantiene Ubuntu 22.04 para compatibilidad

    steps:
    # 1. Descarga el repositorio
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Configura Node.js y PNPM
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18
    
    - name: Install PNPM
      run: |
        npm install -g pnpm
        pnpm setup
      env:
        PNPM_HOME: ~/.pnpm
      shell: bash

    # 3. Agrega PNPM al PATH del sistema
    - name: Add PNPM to PATH
      run: echo "export PATH=$PATH:~/.pnpm" >> ~/.bashrc && source ~/.bashrc
      shell: bash

    # 4. Instala TypeScript versi√≥n 5.2 o superior
    - name: Install TypeScript Globally
      run: pnpm add typescript@5.2 --global

    # 5. Instala dependencias utilizando PNPM
    - name: Install dependencies
      run: pnpm install

    # 6. Instala dependencias del sistema (compatible con Tauri)
    - name: Install Linux Dependencies for Tauri
      run: |
        sudo apt update
        sudo apt install -y libwebkit2gtk-4.0-dev \
          build-essential libssl-dev curl

    # 7. Construye el proyecto (frontend y bundling de Tauri)
    - name: Build frontend and backend
      run: pnpm build

    # 8. Construye y empaqueta la app Tauri (.deb)
    - name: Build Tauri App
      run: pnpm tauri build

    # 9. Subir binarios empaquetados como artefactos
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@main
      with:
        name: tuxclip-artifacts
        path: src-tauri/target/release/bundle